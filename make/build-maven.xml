<project basedir=".">

  <target name="maven-dist" depends="init, compile, artifacts, resin.dist.jar">
    <property name="maven" value="${maven.root}/com/caucho/"/>
    
    <antcall target="maven2-jar" inheritRefs="true">
      <param name="maven.name" value="resin"/>
      <param name="jar" value="${dist}/${dist.name}/lib/resin.jar"/>
      <param name="pom.xml" value="${modules}/resin/maven2/pom.xml"/>
      <param name="ivy.xml" value="${modules}/resin/maven2/ivy.xml"/>
    </antcall>

    <antcall target="maven2-jar" inheritRefs="true">
      <param name="maven.name" value="resin-javaee7"/>
      <param name="jar" value="${dist}/${dist.name}/lib/javaee-7.jar"/>
      <param name="pom.xml" value="${modules}/javaee/maven2/pom.xml"/>
      <param name="ivy.xml" value="${modules}/javaee/maven2/ivy.xml"/>
    </antcall>
  	
    <antcall target="maven2-module" inheritRefs="true">
      <param name="module.name" value="kernel"/>
      <param name="jar.name" value="resin-kernel.jar"/>
      <param name="maven.name" value="resin-kernel"/>
    </antcall>
  	
    <antcall target="maven2-module" inheritRefs="true">
      <param name="module.name" value="quercus"/>
      <param name="jar.name" value="quercus.jar"/>
      <param name="maven.name" value="quercus"/>
    </antcall>
<!--
    <antcall target="maven2-artifact" inheritRefs="true">
      <param name="module.name" value="ant"/>
      <param name="jar.name" value="resin-ant.jar"/>
      <param name="maven.name" value="resin-ant"/>
    </antcall>

    <antcall target="maven2-artifact" inheritRefs="true">
      <param name="module.name" value="eclipse"/>
      <param name="jar.name"
	     value="com.caucho.resin.eclipse_${version}.jar"/>
      <param name="maven.name" value="resin-eclipse"/>
    </antcall>
-->
    <!--
    <antcall target="maven2-module" inheritRefs="true">
      <param name="module.name" value="deploy"/>
      <param name="jar.name" value="resin-deploy.jar"/>
      <param name="maven.name" value="resin-deploy"/>
    </antcall>
    -->

    <antcall target="maven2-module" inheritRefs="true">
      <param name="module.name" value="hessian"/>
      <param name="jar.name" value="hessian.jar"/>
      <param name="maven.name" value="resin-hessian"/>
    </antcall>
<!--
    <antcall target="maven2-artifact" inheritRefs="true">
      <param name="module.name" value="maven"/>
      <param name="jar.name" value="resin-maven-plugin.jar"/>
      <param name="maven.name" value="resin-maven-plugin"/>
    </antcall>
-->
    <!--
    <antcall target="maven2-artifact" inheritRefs="true">
      <param name="module.name" value="netbeans"/>
      <param name="module.ext" value="nbm"/>
      <param name="jar.name" value="resin-netbeans.nbm"/>
      <param name="maven.name" value="resin-netbeans"/>
    </antcall>
-->
    <!--
    <antcall target="maven2-artifact" inheritRefs="true">
      <param name="module.name" value="spring"/>
      <param name="jar.name" value="resin-spring.jar"/>
      <param name="maven.name" value="resin-spring"/>
    </antcall>
    -->

    <!--
    <antcall target="maven2-module" inheritRefs="true">
      <param name="module.name" value="support"/>
      <param name="jar.name" value="resin-support.jar"/>
      <param name="maven.name" value="resin-support"/>
    </antcall>
    -->
  </target>

  <target name="maven-rsync" depends="init,maven-dist">
    <exec executable="rsync">
      <arg value="-av"/>
      <arg value="--rsh=ssh"/>
      <arg value="${maven.root}"/>
      <arg value="caucho@weasley.caucho.com:/var/www/hosts/www.caucho.com/webapps/"/>
    </exec>
  </target>
  
  <target name="rest-jar" depends="init, compile">
    <property name="dist.name" value="${shortproduct}-${version}"/>
    <mkdir dir="${dist}/${dist.name}"/>

    <jar destfile="${dist}/resin-rest-${version}.jar">
      <fileset dir="${modules}/resin/classes">
        <exclude name=".cvsignore"/>
        <exclude name=".svnignore"/>
        <exclude name="*~"/>
        <exclude name="**/CVS/**"/>
        <exclude name="**/.svn/**"/>
        <exclude name="com/caucho/soa/rest/HessianRestProxy.class"/>
        <exclude name="com/caucho/soa/rest/HessianRestProtocolServlet.class"/>
        <exclude name="com/caucho/soa/rest/JAXBRestProxy.class"/>
        <exclude name="com/caucho/soa/rest/JAXBRestProtocolServlet.class"/>
        <exclude name="com/caucho/soa/rest/RestProxy*.class"/>
        <exclude name="com/caucho/soa/rest/RestProtocolServlet.class"/>

        <include name="com/caucho/soa/rest/**"/>
      </fileset>
    </jar>
  </target>

  <target name="hessian-flash" depends="init">
    <taskdef resource="flexTasks.tasks" classpath="${user.home}/flash/ant/lib/flexTasks.jar" />
    <property name="FLEX_HOME" value="${user.home}/flash"/>

    <property name="dist.name" value="${shortproduct}-${version}"/>
    <mkdir dir="${dist}/${dist.name}"/>
    
    <compc output="${modules}/flash/build/hessian-flash.swc">
      <source-path path-element="${modules}/flash/src"/>
      <include-sources 
        dir="${modules}/flash/src" 
        includes="hessian/client/HessianProxy.as 
                  hessian/client/HessianAsyncToken.as 
                  hessian/io/AbstractHessianInput.as 
                  hessian/io/AbstractHessianOutput.as 
                  hessian/io/Double.as 
                  hessian/io/Float.as 
                  hessian/io/Hessian2Constants.as
                  hessian/io/Hessian2Input.as
                  hessian/io/HessianOutput.as
                  hessian/io/Hessian2StreamingInput.as
                  hessian/io/Hessian2StreamingOutput.as
                  hessian/io/HessianProtocolError.as
                  hessian/io/HessianServiceError.as
                  hessian/io/ObjectDefinition.as
                  hessian/events/*.as"/>
    </compc>

    <compc output="${modules}/flash/build/hessian-flex.swc">
      <source-path path-element="${modules}/flash/src"/>
      <include-sources 
        dir="${modules}/flash/src" 
        includes="hessian/client/*.as 
                  hessian/io/*.as 
                  hessian/events/*.as 
                  hessian/mxml/*.as"/>
    </compc>

    <compc output="${modules}/flash/build/bam-flash.swc">
      <source-path path-element="${modules}/flash/src"/>
      <include-sources 
        dir="${modules}/flash/src" 
        includes="bam/*.as 
                  bam/hmtp/*.as 
                  com/caucho/xmpp/*.as
                  com/caucho/xmpp/ping/*.as"/>
      <compiler.include-libraries dir="${modules}/flash/build" append="true">
        <include name="hessian-flash.swc" />
      </compiler.include-libraries>
    </compc>

    <jar destfile="${dist}/${dist.name}/hessian-flex-${version}-src.jar">
      <fileset dir="${modules}/flash/src">
        <exclude name=".cvsignore"/>
        <exclude name=".svnignore"/>
        <exclude name="*~"/>
        <exclude name="**/CVS/**"/>
        <exclude name="**/.svn/**"/>

        <include name="hessian/**"/>
      </fileset>
      <fileset dir="${basedir}">
        <include name="apache.license"/>
      </fileset>
    </jar>
  </target>

  <target name="maven-plugin" depends="init">
    <property name="module.src" value="${artifacts}/maven/src"/>
    <property name="module.build" value="${artifacts}/maven/classes"/>
    
    <mkdir dir="${module.build}" />

    <copy tofile="${module.build}/META-INF/maven/com.caucho/resin-maven-plugin/pom.xml"
          file="${artifacts}/maven/maven2/pom.xml"
          preservelastmodified="true"
          overwrite="true">
      <filterset>
        <filter token="VERSION" value="${maven.version}"/>
      </filterset>
    </copy>

    <copy tofile="${module.build}/META-INF/maven/plugin.xml"
          file="${module.src}/META-INF/maven/plugin.xml.in"
          preservelastmodified="true"
          overwrite="true">
      <filterset>
        <filter token="VERSION" value="${maven.version}"/>
      </filterset>
    </copy>
   
    <antcall target="artifact" inheritRefs="true">
      <param name="artifact.name" value="maven"/>
      <param name="artifact.jar" value="resin-maven-plugin.jar"/>
    </antcall>
  </target>

  <target name="maven2-artifact">
    <property name="jar.name" value="${module.name}.jar"/>
    
    <antcall target="maven2-module" inheritRefs="true">
      <param name="module.dir" value="${resin.artifacts}"/>
      <param name="jar" value="${resin.artifacts}/${module.name}/dist/${jar.name}"/>
    </antcall>
  </target>
    
  <target name="maven2-module">
    <property name="module.dir" value="${resin.modules}"/>
    <property name="module.src" value="${module.dir}/${module.name}/src"/>
    <property name="jar.name" value="${module.name}.${module.ext}"/>
    <property name="maven.name" value="resin-${module.name}"/>
    <property name="maven.dist" value="${maven}/${maven.name}/${maven.version}"/>
    <property name="jar" value="${lib}/${jar.name}"/>

    <mkdir dir="${maven.dist}"/>

    <antcall target="maven2-jar" inheritRefs="true">
      <param name="pom.xml" value="${module.dir}/${module.name}/maven2/pom.xml"/>
      <param name="ivy.xml" value="${module.dir}/${module.name}/maven2/ivy.xml"/>
    </antcall>
  </target>

  <target name="maven2-jar">
    <!-- PARAMETERS -->
    <!--
         maven.name
         maven.jar
         ivy.xml
         pom.xml
    -->
    <property name="maven.dist" value="${maven}/${maven.name}/${maven.version}"/>
    <property name="module.ext" value="jar"/>

    <copy file="${pom.xml}"
          tofile="${maven.dist}/${maven.name}-${maven.version}.pom"
          preservelastmodified="true"
          overwrite="true">
      <filterset>
        <filter token="VERSION" value="${maven.version}"/>
        <filter token="DATE" value="${date}"/>
        <filter token="VERSION_DATE" value="${vdate}"/>
      </filterset>
    </copy>

    <checksum file="${maven.dist}/${maven.name}-${maven.version}.pom"
              algorithm="sha1"/>
    <checksum file="${maven.dist}/${maven.name}-${maven.version}.pom"
              algorithm="md5"/>

    <copy file="${jar}"
          tofile="${maven.dist}/${maven.name}-${maven.version}.${module.ext}"
          preservelastmodified="true"
          overwrite="true"/>

    <checksum file="${maven.dist}/${maven.name}-${maven.version}.${module.ext}"
              algorithm="sha1"/>
    <checksum file="${maven.dist}/${maven.name}-${maven.version}.${module.ext}"
              algorithm="md5"/>

    <copy file="${ivy.xml}"
          tofile="${maven.dist}/ivy-${maven.version}.xml"
          preservelastmodified="true"
          overwrite="true">
      <filterset>
        <filter token="VERSION" value="${maven.version}"/>
        <filter token="DATE" value="${date}"/>
        <filter token="VERSION_DATE" value="${vdate}"/>
      </filterset>
    </copy>

    <copy file="maven2/${maven.metadata.template}-metadata.xml"
          tofile="${maven}/${maven.name}/maven-metadata.xml"
          preservelastmodified="true"
          overwrite="true">
      <filterset>
        <filter token="VERSION" value="${maven.version}"/>
        <filter token="DATE" value="${date}"/>
        <filter token="VERSION_DATE" value="${vdate}"/>
        <filter token="ARTIFACT" value="${maven.name}"/>
      </filterset>
    </copy>
    
    <checksum file="${maven}/${maven.name}/maven-metadata.xml"
              algorithm="sha1"/>
    <checksum file="${maven}/${maven.name}/maven-metadata.xml"
              algorithm="md5"/>

  </target>

  <target name="update">
    <!-- <mkdir dir="${maven.lib}"/>-->
    <!-- XXX: temp build issues
    <artifact:dependencies filesetId="dependency.classpath">
      <pom file="maven.xml"/>
    </artifact:dependencies>

    <mkdir dir="${maven.lib}"/>
    <copy todir="${maven.lib}">
      <fileset refid="dependency.classpath"/>
      <mapper type="flatten"/>
    </copy>
    -->

    <delete file="${maven.lib}/ant-1.6.5.jar" failonerror="false"/>
  </target>

</project>
