<project basedir=".">

  <target name="dist.clean">
    <delete dir="${dist}/${dist.name}"/>
  </target>

  <target name="dist" depends="dist.clean, compile, update, junit, native, resin.dist.build, dist.package"/>

  <target name="distclean" depends="init, clean, win32clean">
    <delete dir="${install}/conf"/>
    <delete dir="${lib}"/>
    <delete dir="${maven.lib}"/>
    <delete dir="${clientlib}"/>
    <delete dir="${install}/unix"/>

    <delete dir="${install}/log"/>
    <delete dir="${install}/bin"/>
    <delete dir="${install}/doc/WEB-INF"/>
    <delete dir="${install}/cache"/>
    <delete dir="${install}/php/quercus-war/WEB-INF/lib"/>
  </target>

  <target name="dist.configure.make" depends="dist">
    <exec dir="${dist}/${dist.name}" executable="./configure">
      <arg value="--prefix=/opt/resin"/>
    </exec>

    <exec dir="${dist}/${dist.name}" executable="make"/>
  </target>

  <target name="quercus.war" depends="init, resin.dist.jar">
    <property name="quercus.dist.name" value="quercus-war-${version}"/>
  
    <delete dir="${dist}/${quercus.dist.name}"/>
    <delete file="${dist}/quercus-${version}.war"/>
  
    <mkdir dir="${dist}/${quercus.dist.name}"/>
    <mkdir dir="${dist}/${quercus.dist.name}/WEB-INF/licenses"/>

    <copy tofile="${dist}/${quercus.dist.name}/WEB-INF/lib/resin.jar"
          file="${dist.build}/lib/resin.jar"/>

    <copy tofile="${dist}/${quercus.dist.name}/WEB-INF/lib/javaee-7.jar"
          file="${dist.build}/lib/javaee-7.jar"/>

    <!--
    <copy tofile="${dist}/${quercus.dist.name}/WEB-INF/lib/cdi-7.jar"
          file="${lib.baratine}/cdi-7.jar"/>
-->
    <copy tofile="${dist}/${quercus.dist.name}/WEB-INF/lib/javamail-141.jar"
          file="${lib.resin}/javamail-141.jar"/>
          
    <copy tofile="${dist}/${quercus.dist.name}/WEB-INF/web.xml"
          file="${resin.dir}/php/quercus-war/WEB-INF/web.xml"/>
    
    <copy tofile="${dist}/${quercus.dist.name}/images/caucho-white.jpg"
          file="${resin.dir}/php/quercus-war/images/caucho-white.jpg"/>

    <copy tofile="${dist}/${quercus.dist.name}/images/dragonfly-tiny.png"
          file="${resin.dir}/php/quercus-war/images/dragonfly-tiny.png"/>

    <copy tofile="${dist}/${quercus.dist.name}/index.php"
          file="${resin.dir}/php/quercus-war/index.php"/>

    <copy tofile="${dist}/${quercus.dist.name}/README"
          file="${resin.dir}/php/quercus-war/README"/>

    <jar destfile="${dist}/quercus-${version}.war">
      <fileset dir="${dist}/${quercus.dist.name}">
        <include name="WEB-INF/lib/resin.jar"/>
	<include name="WEB-INF/lib/javaee-7.jar"/>
        <include name="WEB-INF/lib/cdi-7.jar"/>
        <include name="WEB-INF/lib/javamail-141.jar"/>
        <include name="WEB-INF/licenses"/>
        <include name="WEB-INF/web.xml"/>
        <include name="images/caucho-white.jpg"/>
        <include name="images/dragonfly-tiny.png"/>
        <include name="index.php"/>
        <include name="README"/>
      </fileset>
      <fileset dir="${basedir}">
        <include name="LICENSE"/>
      </fileset>
    </jar>
    
    <delete file="${dist}/quercus-${version}-src.jar"/>

    <jar destfile="${dist}/quercus-${version}-src.jar">
      <fileset dir="${modules.resin}/quercus/src">
        <exclude name=".cvsignore"/>
        <exclude name=".svnignore"/>
        <exclude name="*~"/>
        <exclude name="**/CVS/**"/>
        <exclude name="**/.svn/**"/>
        <include name="com/caucho/**"/>
      </fileset>
      <fileset dir="${basedir}">
        <include name="LICENSE"/>
      </fileset>
    </jar>
    
    <copy tofile="${dist}/quercus-7_0-snap.war"
          file="${dist}/quercus-${version}.war"/>

    <copy tofile="${dist}/quercus-7_0-snap-src.jar"
          file="${dist}/quercus-${version}-src.jar"/>
  </target>

  <!--
  <target name="clean" depends="init">
    <delete>
      <fileset dir="${modules}">
        <include name="*/classes/**"/>
        <include name="*/dist/**"/>
      </fileset>
    </delete>
    <delete>
      <fileset dir=".">
        <include name="**/*.class"/>
      </fileset>
    </delete>
    <delete dir="${build}"/>
    <delete dir="${dist}"/>
  </target>
  -->

</project>
